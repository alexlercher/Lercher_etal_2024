---
title: "XR090_heatmap_fpkm_filter"
author: "Alexander Lercher"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
#--------------------------------------------------------------------
# LOAD PACKAGES
#--------------------------------------------------------------------
library(readr)
library(tidyverse)
library(dplyr)
library(pheatmap)

#--------------------------------------------------------------------
# DATA IMPORT AND CLEANUP
#--------------------------------------------------------------------
list_of_files <- list.files(path = "input/DESeq2",
                            recursive = TRUE,
                            pattern = ".tsv",
                            full.names = TRUE)

data <- readr::read_tsv(list_of_files, id = NULL)

data_fpkm <- read.delim("input/NormSeqData/XR090_FPKM.tsv")

# what are the comparisons made
data_summary <- data %>%
  group_by(comparison) %>%  
  distinct(comparison_name)

#--------------------------------------------------------------------
# FILTER for and identify SIGNIFICANT DEG
#--------------------------------------------------------------------
# define log2FC and adjPval cutoffs
log2FC_cutoff = 1
adjpval_cutoff = 0.05

# subset data by cutoff criteria
significant_DEG <- data %>%
  group_by(comparison) %>%
  filter(abs(log2FoldChange) > log2FC_cutoff & padj < adjpval_cutoff)

# count significant genes per condition
count_DEG <-  significant_DEG %>%
  group_by(comparison, comparison_name) %>%
  count(nrow(comparison)) %>%
  dplyr::rename(DEG_count = n) %>%
  print()

# put DEG of individual comparisons into list
list_DEG_comparisons <- list()
for(i in 1:length(count_DEG$comparison)){
  subset_comparison <- subset(significant_DEG, significant_DEG$comparison == i)
  comparison_name <- unique(subset_comparison$comparison_name)
  list_DEG_comparisons[[paste0(i,"_",comparison_name)]] <- subset_comparison
  rm(subset_comparison,comparison_name)
}

#--------------------------------------------------------------------
# CURATE FPKM data
#--------------------------------------------------------------------
# add means for all conditions
data_fpkm$mean_MA10naive_ctrl <-apply(data_fpkm[,2:4],1,mean)
data_fpkm$mean_MA10naive_polyIC <-apply(data_fpkm[,5:7],1,mean)
data_fpkm$mean_MA10rec_ctrl <-apply(data_fpkm[,8:10],1,mean)
data_fpkm$mean_MA10rec_polyIC <-apply(data_fpkm[,11:13],1,mean)
data_fpkm$mean_PR8naive_ctrl <-apply(data_fpkm[,14:16],1,mean)
data_fpkm$mean_PR8naive_polyIC <-apply(data_fpkm[,17:19],1,mean)
data_fpkm$mean_PR8rec_ctrl <-apply(data_fpkm[,20:22],1,mean)
data_fpkm$mean_PR8rec_polyIC <-apply(data_fpkm[,23:25],1,mean)

# rename column gene to gene_id column
data_fpkm <- data_fpkm %>%
  dplyr::rename(gene_id = gene)

#--------------------------------------------------------------------
# LOAD ISG INFO
#--------------------------------------------------------------------
# import ISG list from Schoggins Nature paper, generated by Alex Popa
# problem is that all ISGs are in full caps
ISG_list  <- read.delim("input/ISG_List.csv")

# here i will put the gene names in lower case
# gene names are separated into first letter and rest
# first letter is capitalized, rest is kept lowercase
ISG_list = ISG_list %>%
  mutate(gene_low = tolower(gene),
         first_letter = substr(gene_low,1,1),
         first_letter_cap = toupper(first_letter),
         rest = substr(gene_low,2,20)
  )

# save ISG list as dataframe with the column name "gene"
# add a TRUE column for all ISGs
ISG_list = as.data.frame(paste(ISG_list$first_letter_cap,ISG_list$rest,sep=""))
colnames(ISG_list) = c("gene_id")
ISG_list$ISG = T

#--------------------------------------------------------------------
# DO HEATMAPS only for CONDITIONS of INTEREST
#--------------------------------------------------------------------
#--------------------------------------------------------------------
# SUBSET to MA10 only COMPARISONS
#--------------------------------------------------------------------
# define comparisons of interest
MA10only <- data_summary %>%
  filter(grepl("MA10", comparison_name) & !grepl("PR8", comparison_name)) %>%
  print()

# FPKM values for only for MA10 comparisons
MA10only_fpkm <- data_fpkm %>%
  dplyr::select(contains(c("gene","MA10")) & !contains(c("mean")))

# calculate average FPKM level across all samples and define FPKM cutoff
MA10only_fpkm <- MA10only_fpkm %>%
  mutate(average_fpkm = rowSums(MA10only_fpkm[2:length(MA10only_fpkm)]/(length(MA10only_fpkm)-1)))

FPKM_cutoff <- 1

MA10only_fpkm %>%
  ggplot(aes(x=average_fpkm)) +
    geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) +
    scale_x_continuous(trans='log10') +
    ggtitle("Average FPKM before cutoff") +
    geom_vline(xintercept = FPKM_cutoff) +
    theme_bw()

# filter according to FPKM cutoff
MA10only_fpkm <- MA10only_fpkm %>%
  filter(average_fpkm > FPKM_cutoff)

MA10only_fpkm %>%
  ggplot(aes(x=average_fpkm)) +
  geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) +
  scale_x_continuous(trans='log10') +
  ggtitle("Average FPKM after cutoff") +
  geom_vline(xintercept = FPKM_cutoff) +
  theme_bw()

# drop average FPKM column
MA10only_fpkm <- MA10only_fpkm %>%
  dplyr::select(!average_fpkm)

# loop over comparisons of interest
# 1) cluster genes
# 2) plot heatmaps
# 3) add cluster info to gene list

DEG_comparisons_cluster_list <- list()
DEG_comparisons_cluster_DF <- data.frame()

for(i in 1:4){
# select condition of interest
conditionOI <- list_DEG_comparisons[[i]]

# extract DEG from condition of interest
genesOI <- data.frame(gene_id = conditionOI$gene_id)

# get FPKM for DEG of interest
fpkmOI <- left_join(genesOI,MA10only_fpkm)
fpkmOI <- na.omit(fpkmOI)
row.names(fpkmOI) <- fpkmOI$gene_id
fpkmOI$gene_id <- NULL

#--------------------------------------------------------------------
# PLOT HEATMAP with ROW Z SCORES
#--------------------------------------------------------------------
# define formula to calculate row Z score
cal_z_score <- function(x){
  (x - mean(x)) / sd(x)
}

# calculate row Z score for FPKMs for each row (gene) of interest
fpkmOI_norm <- t(apply(fpkmOI, 1, cal_z_score))

# annotate sample columns
my_sample_col <- data.frame(sample = c(rep("MA10naive_ctrl",3),
                                       rep("MA10naive_polyIC",3),
                                       rep("MA10rec_ctrl",3),
                                       rep("MA10rec_polyIC",3)))
row.names(my_sample_col) <- colnames(fpkmOI)

# calculate dendrogram
hc <- hclust(dist(fpkmOI_norm), method = "complete")
#as.dendrogram(hc) %>%  #no need to print dendrogram
#  plot(horiz = T)

# obtain gene names as per dendrogram
#genes_order <- rev(row.names(fpkmOI_norm)[hc$order]) #no need to print gene names

# add cluster information to heatmap
numberofclusters = 6
my_gene_col <-cutree(hc, k = numberofclusters)
my_gene_col <- data.frame(cluster = ifelse(test = my_gene_col == 1, yes = "1",
                                           ifelse(test = my_gene_col == 2, yes = "2",
                                                  ifelse(test = my_gene_col == 3, yes = "3",
                                                         ifelse(test = my_gene_col == 4, yes = "4",
                                                                ifelse(test = my_gene_col == 5, yes = "5", no = "6"
                                                         ))))))

# merge ISG_list heatmap row/gene names to add ISG info
my_gene_col$gene_id <- rownames(my_gene_col)
my_gene_col <- my_gene_col %>%
  left_join(ISG_list) %>%
  replace(is.na(.), FALSE)
my_gene_col$ISG <-as.integer(my_gene_col$ISG)
rownames(my_gene_col) <- my_gene_col$gene_id
my_gene_col$gene_id <- NULL

pheatmap(fpkmOI_norm, annotation_col = my_sample_col, annotation_row = my_gene_col, 
         show_rownames = F, main = paste0(i,":",as.character(MA10only[i,2])),
         #color = colorRampPalette(c("midnightblue", "ivory", "firebrick3"))(50),
         cutree_rows = numberofclusters,
         filename = paste0("output/fpkm_filter/",i,"_",as.character(MA10only[i,2]),"_fpkm_filter_6clusters.pdf"))

# add cluster and ISG information to DEG list
my_gene_col$gene_id <- rownames(my_gene_col) 
conditionOI_cluster <- conditionOI %>%
  left_join(my_gene_col) %>%
  na.omit()
DEG_comparisons_cluster_list[[paste0(i,"_",as.character(MA10only[i,2]))]] <- conditionOI_cluster
DEG_comparisons_cluster_DF <- rbind(DEG_comparisons_cluster_DF,conditionOI_cluster)

write_tsv(conditionOI_cluster, paste0("output/fpkm_filter/",i,"_",as.character(MA10only[i,2]),"_cluster_fpkm_filter_6clusters.tsv"))

}

#--------------------------------------------------------------------
# CLUSTER GENES SIGNIFICANT IN AT LEAST ONE MA10 CONDITION
#--------------------------------------------------------------------
# get all significant DEG for MA10 comparisons
sig_DEG_MA10 <- significant_DEG %>%
  group_by(comparison_name) %>%
  filter(grepl("MA10",comparison_name) & !grepl("PR8",comparison_name))

# reduce to unique significatn DEG for MA10 comparisons
unique_sig_DEG_MA10 <- data.frame(gene_id = unique(sig_DEG_MA10$gene_id))

# get FPKM for DEG of interest
fpkmOI <- left_join(unique_sig_DEG_MA10,MA10only_fpkm)
fpkmOI <- na.omit(fpkmOI)
row.names(fpkmOI) <- fpkmOI$gene_id
fpkmOI$gene_id <- NULL

# define formula to calculate row Z score
cal_z_score <- function(x){
  (x - mean(x)) / sd(x)
}

# calculate row Z score for FPKMs for each row (gene) of interest
fpkmOI_norm <- t(apply(fpkmOI, 1, cal_z_score))

# annotate sample columns
my_sample_col <- data.frame(sample = c(rep("MA10naive_ctrl",3),
                                       rep("MA10naive_polyIC",3),
                                       rep("MA10rec_ctrl",3),
                                       rep("MA10rec_polyIC",3)))
row.names(my_sample_col) <- colnames(fpkmOI)

# calculate dendrogram
hc <- hclust(dist(fpkmOI_norm), method = "complete")

# add cluster information to heatmap
numberofclusters = 6
my_gene_col <-cutree(hc, k = numberofclusters)
my_gene_col <- data.frame(cluster = ifelse(test = my_gene_col == 1, yes = "1",
                                           ifelse(test = my_gene_col == 2, yes = "2",
                                                  ifelse(test = my_gene_col == 3, yes = "3",
                                                         ifelse(test = my_gene_col == 4, yes = "4",
                                                                ifelse(test = my_gene_col == 5, yes = "5", no = "6"
                                                                ))))))

# merge ISG_list heatmap row/gene names to add ISG info
my_gene_col$gene_id <- rownames(my_gene_col)
my_gene_col <- my_gene_col %>%
  left_join(ISG_list) %>%
  replace(is.na(.), FALSE)
my_gene_col$ISG <-as.integer(my_gene_col$ISG)
rownames(my_gene_col) <- my_gene_col$gene_id
my_gene_col$gene_id <- NULL

pheatmap(fpkmOI_norm, annotation_col = my_sample_col, annotation_row = my_gene_col, 
         show_rownames = F, main = "significant in at least one MA10 comparison",
         #color = colorRampPalette(c("midnightblue", "ivory", "firebrick3"))(50),
         cutree_rows = numberofclusters,
         filename = "output/fpkm_filter/all_MA10_DEG_fpkm_filter_6clusters.pdf")

# add cluster and ISG information to DEG list
my_gene_col$gene_id <- rownames(my_gene_col) 
sig_DEG_MA10_cluster <- sig_DEG_MA10 %>%
  left_join(my_gene_col) %>%
  na.omit()

write_tsv(sig_DEG_MA10_cluster, "output/fpkm_filter/all_MA10_DEG_cluster_fpkm_filter_6clusters.tsv")

# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()






```

